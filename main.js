!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(t=e,s=this.boardSize,0===t?"top-left":t<s-1?"top":t===s-1?"top-right":t%s==0&&t!==s*(s-1)?"left":t%s==7&&t!==s*s-1?"right":t===s*(s-1)?"bottom-left":t===s*s-1?"bottom-right":t>s*(s-1)&&t<s*s-1?"bottom":"center")),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const r=document.createElement("div");r.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${s.character.health}%`,r.appendChild(l),a.appendChild(r),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),a.appendChild(r),r.addEventListener("animationend",(()=>{a.removeChild(r),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{constructor(e){this.characters=new Set,this.add(e)}add(e){if(e.length<1)throw new Error("No arguments were passed to the constructor of the Team class");e.forEach((e=>{this.characters.add(e)}))}toArray(){if(this.characters.size<1)throw new Error("–í –∫–æ–º–∞–Ω–¥–µ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π");const e=[];return this.characters.forEach((t=>{e.push(t)})),e}}class s{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("it is forbidden to use new Character")}}class a extends s{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.rangeTravel=2,this.rangeAttacks=2}}class r extends s{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.rangeTravel=1,this.rangeAttacks=4}}class l extends s{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10,this.rangeTravel=1,this.rangeAttacks=4}}class i extends s{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.rangeTravel=4,this.rangeAttacks=1}}class n extends s{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.rangeTravel=2,this.rangeAttacks=2}}class c extends s{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.rangeTravel=4,this.rangeAttacks=1}}function*o(e,t){for(;;){const s=e[Math.floor(Math.random()*e.length)],o=Math.floor(Math.random()*t+1);"Bowman"===s?yield new a(o):"Magician"===s?yield new r(o):"Swordsman"===s?yield new i(o):"Daemon"===s?yield new l(o):"Vampire"===s?yield new n(o):"Undead"===s&&(yield new c(o))}}function h(e,t,s){const a=[];for(let r=0;r<s;r+=1)a.push(o(e,t).next().value);return a}class d{constructor(e,t){if(!(e instanceof s))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}var u="pointer",m="crosshair",v="not-allowed";const f=new e;f.bindToDOM(document.querySelector("#game-container"));const g=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),C=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.selectedCharacter=this.gamePlay.cells.findIndex((e=>e.classList.contains("selected-yellow")))}init(){this.gamePlay.drawUi("prairie");const e=new t(h(["Magician","Swordsman","Bowman"],1,2)),s=new t(h(["Vampire","Undead","Daemon"],1,2));let a=[];const r=(e,t)=>{if(!a.length)for(let t=0;t<e.length;t+=1)for(let s=0;s<this.gamePlay.boardSize;s+=1)a.push(s*this.gamePlay.boardSize+e[t]);const s=Math.floor(Math.random()*a.length),r=a[s];return a.splice(s,1),t&&(a=[]),r};this.arrAllTeams=e.toArray().map(((t,s)=>new d(t,r([0,1],e.characters.size-1===s)))).concat(s.toArray().map(((t,s)=>new d(t,r([6,7],e.characters.size-1===s))))),this.gamePlay.redrawPositions(this.arrAllTeams),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))}onCellClick(t){const s=event.currentTarget.firstElementChild;if(null!==s)if(-1!==this.selectedCharacter&&this.gamePlay.deselectCell(this.selectedCharacter),/bowman|swordsman|magician/.test(s.className)){this.selectedCharacter=t,this.gamePlay.selectCell(t);const e=this.arrAllTeams.find((e=>e.position===t)).character||null;null!==e&&([this.arrayAvailableCells,this.arrayAvailableCellsAttack]=function(e,t,s,a){let r=[],l=[];const i=[];let n,c;for(let e=0;e<a;e+=1){i[e]=[];for(let t=0;t<a;t+=1)i[e][t]=e*a+t,i[e][t]===s&&(n=e,c=t)}for(let t=-e;t<=e;t+=1)n+t>=0&&n+t<a&&r.push(i[n+t][c]),c+t>=0&&c+t<a&&r.push(i[n][c+t]),n+t>=0&&n+t<a&&c+t>=0&&c+t<a&&r.push(i[n+t][c+t]),n-t>=0&&n-t<a&&c+t>=0&&c+t<a&&r.push(i[n-t][c+t]);let o=null,h=null;for(let e=-t;e<=t;e+=1)null===o&&(o=[n+e,c+e]),h=[n+e,c+e];function d(){const e=[];for(var t=arguments.length,s=new Array(t),r=0;r<t;r++)s[r]=arguments[r];return s.forEach((t=>{t<0?e.push(0):t>=a?e.push(a-1):e.push(t)})),e}o=d(...o),h=d(...h);for(let e=o[0];e<=h[0];e+=1)for(let t=o[1];t<=h[1];t+=1)l.push(i[e][t]);return r=r.filter((e=>s!==e)),l=l.filter((e=>s!==e)),[r,l]}(e.rangeTravel,e.rangeAttacks,t,this.gamePlay.boardSize))}else e.showError("enemy");if(this.arrayAvailableCells.includes(t)&&null===s){const e=this.arrAllTeams.findIndex((e=>e.position===this.selectedCharacter));e>=0&&(this.arrAllTeams[e].position=t,this.gamePlay.deselectCell(this.selectedCharacter),this.selectedCharacter=t,this.gamePlay.redrawPositions(this.arrAllTeams),this.onCellClick(t))}}onCellEnter(e){if(-1===this.selectedCharacter?event.currentTarget.style.cursor=v:this.arrayAvailableCells.includes(e)&&!event.currentTarget.hasChildNodes()?(event.currentTarget.style.cursor=u,this.gamePlay.selectCell(e,"green")):event.currentTarget.style.cursor=v,event.currentTarget.hasChildNodes()){const t=this.arrAllTeams.find((t=>t.position===e)).character||null;if(t){const s=function(e){return`üéñ${e.level}‚öî${e.attack} üõ° ${e.defence} ‚ù§${e.health}`}(t);this.gamePlay.showCellTooltip(s,e),/bowman|swordsman|magician/.test(t.type)?event.currentTarget.style.cursor=u:/vampire|undead|daemon/.test(t.type)&&this.arrayAvailableCellsAttack&&this.arrayAvailableCellsAttack.includes(e)&&(event.currentTarget.style.cursor=m)}}}onCellLeave(e){event.currentTarget.hasChildNodes()&&this.gamePlay.hideCellTooltip(e),e!==this.selectedCharacter&&this.gamePlay.deselectCell(e)}}(f,g);C.init()}();